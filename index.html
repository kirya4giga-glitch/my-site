<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kiru OS v23 - Apple Aesthetic</title>
    <style>
        :root { 
            --bg: #000; 
            --main: #007AFF; /* Apple Blue */
            --glass: rgba(255, 255, 255, 0.1); 
            --txt: #ffffff; 
            --grad: linear-gradient(135deg, #007AFF, #00C7FF);
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: radial-gradient(circle at top right, #1a1a1a, #000);
            color: var(--txt); 
            margin: 0; 
            padding: 20px;
            transition: all 0.5s ease;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* –≠—Å—Ç–µ—Ç–∏—á–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ —Å—Ç–∏–ª–µ Apple */
        .game-box { 
            background: var(--glass); 
            backdrop-filter: blur(15px); 
            -webkit-backdrop-filter: blur(15px);
            padding: 20px; 
            border-radius: 25px; 
            margin: 0 auto 20px auto; 
            width: 95%; 
            max-width: 450px; 
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* –ü–ª–∞–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */
        .button-tea { 
            padding: 12px 20px; 
            background: var(--grad); 
            color: white; 
            border: none; 
            border-radius: 12px; 
            cursor: pointer; 
            font-weight: 600; 
            margin: 5px; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(0, 122, 255, 0.3);
        }
        .button-tea:hover { transform: scale(1.05); box-shadow: 0 6px 20px rgba(0, 122, 255, 0.5); }
        .button-tea:active { transform: scale(0.95); }

        /* –ß–∞—Ç */
        #cList { 
            height: 300px; 
            overflow-y: auto; 
            background: rgba(0,0,0,0.2); 
            border-radius: 18px; 
            padding: 15px; 
            margin-bottom: 15px; 
            text-align: left; 
            border: 1px solid rgba(255,255,255,0.05);
            scroll-behavior: smooth;
        }
        .msg { 
            background: rgba(255,255,255,0.08); 
            padding: 12px; 
            border-radius: 15px; 
            margin-bottom: 10px; 
            position: relative; 
            transition: 0.3s;
        }
        .msg:hover { background: rgba(255,255,255,0.12); }

        /* –û–∫–Ω–∞ (Modals) */
        .modal { 
            display: none; 
            position: fixed; 
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%); 
            background: rgba(30, 30, 30, 0.9); 
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255,255,255,0.2); 
            padding: 30px; 
            border-radius: 30px; 
            z-index: 2000; 
            width: 85%; 
            max-width: 350px; 
            box-shadow: 0 0 100px rgba(0,0,0,0.8);
            animation: popUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popUp { from { transform: translate(-50%, -40%) scale(0.8); opacity: 0; } to { transform: translate(-50%, -50%) scale(1); opacity: 1; } }

        /* –°–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ —Å—Ç–∏–ª–∏ */
        .prefix { font-size: 10px; padding: 3px 6px; border-radius: 6px; background: white; color: black; margin-right: 6px; }
        .msg-time { opacity: 0.4; font-size: 10px; float: right; margin-top: 10px; }
        #matrixCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; opacity: 0.3; }
        
        /* –ò–≥—Ä—ã */
        .chess-board, .ttt-grid { display: grid; margin: 15px auto; border-radius: 12px; overflow: hidden; border: 2px solid var(--main); }
        .chess-board { grid-template-columns: repeat(8, 1fr); width: 300px; height: 300px; }
        .ttt-grid { grid-template-columns: repeat(3, 1fr); width: 240px; height: 240px; }
        .cell { display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 24px; transition: 0.2s; }
        .cell-w { background: #fff; color: #000; } .cell-b { background: #333; color: #fff; }
    </style>
</head>
<body>
    <canvas id="matrixCanvas"></canvas>

    <div style="position:fixed; top:20px; right:20px; z-index:1001; display:flex; gap:12px;">
        <button class="button-tea" onclick="openMod('shopWin')">üõí Shop</button>
        <button class="button-tea" onclick="openMod('sMenu')">‚öôÔ∏è</button>
    </div>

    <h1 id="h-title" style="font-weight: 800; letter-spacing: -1px;">Kiru OS v23</h1>
    <h3 onclick="eggClick()" style="cursor:pointer">–ë–∞–ª–∞–Ω—Å: <span id="userBalance" style="color:var(--main)">0</span> üí∞</h3>

    <div id="musyaEaster" class="modal">
        <h2 style="color: #FF2D55;">üêæ –°–µ–∫—Ä–µ—Ç–Ω–∞—è –ú—É—Å—è!</h2>
        <img id="musyaImg" src="https://i.postimg.cc/mD3mB8Qf/image.jpg" style="width:100%; border-radius:20px; margin:10px 0;">
        <p>–¢—ã –Ω–∞—à–µ–ª –ª–µ–≥–µ–Ω–¥—É!</p>
        <button class="button-tea" onclick="closeMod('musyaEaster')">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <div id="thanksWin" class="modal">
        <h3>üåü Wall of Fame</h3>
        <ul style="text-align:left; line-height:2.2; font-weight: 500;">
            <li>1. –í–∞–¥–µ–∫—É</li>
            <li>2. –ú—É—Å–µ ‚ù§Ô∏è</li>
            <li>3. –°–∞—à–µ</li>
            <li>4. –ê–Ω–¥—Ä–µ—é üòé</li>
            <li>5. –¢–µ–ø–µ</li>
            <li>6. gemini</li>
            <li>7. –ê–Ω–∞—Å—Ç–∞—Å–∏–µ –ó–µ–º–ª–µ—Ä–æ–π–∫–µ</li>
        </ul>
        <button class="button-tea" onclick="closeMod('thanksWin')">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <div id="sMenu" class="modal">
        <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
        –¢–µ–º–∞: <select onchange="changeTheme(this.value)"><option value="hacker">iOS Dark</option><option value="tg">Telegram</option><option value="snow">Snowy</option></select><br><br>
        –Ø–∑—ã–∫: <select onchange="changeLang(this.value)"><option value="ru">RU</option><option value="en">EN</option></select>
        <hr style="opacity:0.1">
        <button class="button-tea" onclick="openMod('thanksWin')">üåü –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏</button><br>
        <button class="button-tea" onclick="logout()">–í—ã—Ö–æ–¥</button>
        <button class="button-tea" onclick="closeMod('sMenu')">X</button>
    </div>

    <div id="shopWin" class="modal">
        <h3>üõí Apple Market</h3>
        <div class="shop-item"><span>[VIP]</span><button class="button-tea" onclick="buy('prefix', 100, 'VIP')">100</button></div>
        <div class="shop-item"><span>üõ°Ô∏è Shield</span><button class="button-tea" onclick="buy('item', 1000, 'shield')">1000</button></div>
        <button class="button-tea" onclick="closeMod('shopWin')">X</button>
    </div>

    <div id="pCard" class="modal">
        <h2 id="pc-name">User</h2>
        <div id="pc-stats" style="text-align:left; font-size: 15px;"></div>
        <hr style="opacity:0.1">
        <button class="button-tea" onclick="sendMoneyPrompt()">üí∏ –ü–µ—Ä–µ–≤–µ—Å—Ç–∏</button>
        <button class="button-tea" onclick="closeMod('pCard')">X</button>
    </div>

    <div class="game-box">
        <h3 id="h-chat">iChat</h3>
        <div id="cList"></div>
        <div style="display:flex; gap:10px">
            <input type="text" id="mInp" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="flex:1; background:rgba(255,255,255,0.1); border:none; color:white; padding:15px; border-radius:15px; outline:none;">
            <button class="button-tea" onclick="sendMsg()">></button>
        </div>
    </div>

    <div class="game-box">
        <h3 id="h-click">Mining Farm</h3>
        <div id="score" style="font-size:60px; font-weight:800; margin:10px 0;">0</div>
        <button class="button-tea" onclick="doClick()" style="width:80%; padding:20px; font-size:22px; border-radius:20px;">–ö–õ–ò–ö!</button>
        <div id="topList" style="text-align:left; margin-top:20px; border-top:1px solid rgba(255,255,255,0.1); padding-top:15px;"></div>
    </div>

    <div class="game-box">
        <h3 id="h-games">Game Center</h3>
        <div id="active-list" style="font-size:12px; color:var(--main); margin-bottom:10px;"></div>
        <div id="lobby">
            <button class="button-tea" onclick="startMM('ttt')">Tic-Tac-Toe</button>
            <button class="button-tea" onclick="startMM('chess')">Chess</button>
        </div>
        <div id="game-area" class="hidden">
            <div id="g-info"></div>
            <div id="board-container"></div>
            <button class="button-tea" onclick="stopMM()">Quit</button>
        </div>
    </div>

    <div id="reactPicker">
        <span onclick="applyR('üî•')">üî•</span><span onclick="applyR('‚ù§Ô∏è')">‚ù§Ô∏è</span><span onclick="applyR('üëç')">üëç</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, update, push, onValue, remove, off, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const conf = { apiKey: "AIzaSyChSk0gETRBQ391e4BjPqFsKc_dzjBmT58", databaseURL: "https://my-chat-52203-default-rtdb.firebaseio.com", projectId: "my-chat-52203" };
        const db = getDatabase(initializeApp(conf));

        let user = JSON.parse(localStorage.getItem('user_v23'));
        let selId = null, gid = null, myRole = '', eggCounter = 0;

        async function init() {
            if(!user) {
                let n = prompt("Name:"); if(!n) return;
                let p = prompt("Pass:");
                const s = await get(ref(db, 'users/'+n));
                if(s.exists()){ if(s.val().password !== p) return location.reload(); user = {name: n, ...s.val()}; }
                else { user = {name: n, password: p, score: 0, w_ttt:0, w_chess:0}; await set(ref(db, 'users/'+n), user); }
                localStorage.setItem('user_v23', JSON.stringify(user));
            }
            syncUser(); loadChat(); loadTop(); loadActive();
        }

        window.eggClick = () => {
            eggCounter++;
            if(eggCounter === 5) { openMod('musyaEaster'); eggCounter = 0; }
            setTimeout(() => { eggCounter = 0; }, 2000);
        };

        function syncUser() {
            onValue(ref(db, 'users/'+user.name), (s) => {
                const d = s.val(); if(!d) return;
                user = {name: user.name, ...d};
                document.getElementById('userBalance').innerText = d.score || 0;
                document.getElementById('score').innerText = d.score || 0;
                localStorage.setItem('user_v23', JSON.stringify(user));
            });
        }

        window.doClick = () => update(ref(db, 'users/'+user.name), {score: (user.score || 0) + 1});

        // –ß–∞—Ç –∏ —Ä–µ–∞–∫—Ü–∏–∏ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ª–æ–≥–∏–∫–∏)
        function loadChat() {
            onValue(ref(db, 'msgs'), (s) => {
                const l = document.getElementById('cList'); l.innerHTML = "";
                s.forEach(d => {
                    const m = d.val();
                    const ts = m.time ? new Date(m.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : "";
                    let rb = '<div class="react-bar">';
                    if(m.r) Object.entries(m.r).forEach(([emoji, voters]) => { rb += `<span class="react-item">${emoji} ${Object.keys(voters).length}</span>`; });
                    rb += '</div>';
                    const div = document.createElement('div'); div.className = 'msg';
                    div.innerHTML = `<b onclick="event.stopPropagation(); showP('${m.n}')">${m.n}</b>: ${m.t}${rb}<span class="msg-time">${ts}</span>`;
                    div.onclick = (e) => { selId = d.key; const p = document.getElementById('reactPicker'); p.style.display='flex'; p.style.top=(e.clientY-40)+'px'; p.style.left=e.clientX+'px'; };
                    l.appendChild(div);
                });
                l.scrollTop = l.scrollHeight;
            });
        }

        // –¢–ê–ë–õ–ò–¶–ê (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
        window.loadTop = () => {
            onValue(ref(db, 'users'), (s) => {
                const t = document.getElementById('topList'); t.innerHTML = "<b>Top Leaders</b><br>";
                let a = [];
                s.forEach(u => { 
                    let d = u.val();
                    a.push({ n: u.key, s: d.score || 0 });
                });
                a.sort((x,y) => y.s - x.s).slice(0, 8).forEach((u, i) => {
                    t.innerHTML += `<div style="padding:5px 0; border-bottom:1px solid rgba(255,255,255,0.05)">${i+1}. ${u.n} ‚Äî ${u.s} üí∞</div>`;
                });
            });
        }

        // –ò–≥—Ä—ã –∏ –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ (–∫–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–∑ v22)
        window.startMM = async (type) => {
            document.getElementById('lobby').classList.add('hidden'); document.getElementById('game-area').classList.remove('hidden');
            const qRef = ref(db, 'queue_'+type); const snap = await get(qRef);
            if(snap.exists() && snap.val() !== user.name) {
                gid = 'g_'+Date.now();
                await set(ref(db, 'games/'+gid), { p1: snap.val(), p2: user.name, type, turn: 'p1', board: type==='ttt' ? Array(9).fill("") : "rnbqkbnrpppppppp................................PPPPPPPPRNBQKBNR" });
                await remove(qRef); join(gid, 'p2');
            } else { set(qRef, user.name); onValue(ref(db, 'games'), (s) => { s.forEach(g => { if(g.val().p1 === user.name) join(g.key, 'p1'); }); }); }
        };

        function join(id, role) {
            gid = id; myRole = role;
            document.getElementById('lobby').classList.add('hidden'); document.getElementById('game-area').classList.remove('hidden');
            onValue(ref(db, 'games/'+id), (s) => {
                const d = s.val(); if(!d) return; draw(d);
                document.getElementById('g-info').innerText = d.turn===(role==='p1'?'p1':'p2') ? "YOUR TURN" : "WAIT...";
            });
        }

        function draw(d) {
            const cont = document.getElementById('board-container'); cont.innerHTML = "";
            const board = document.createElement('div'); board.className = d.type==='ttt'?'ttt-grid':'chess-board';
            const bArr = typeof d.board === 'string' ? d.board.split('') : d.board;
            bArr.forEach((v, i) => {
                const c = document.createElement('div'); c.className = 'cell ' + (d.type==='chess' ? ((Math.floor(i/8)+i%8)%2 ? 'cell-b' : 'cell-w') : 'cell-b');
                c.innerText = d.type==='chess' ? ({"r":"‚ôú","n":"‚ôû","b":"‚ôù","q":"‚ôõ","k":"‚ôö","p":"‚ôü","R":"‚ôñ","N":"‚ôò","B":"‚ôó","Q":"‚ôï","K":"‚ôî","P":"‚ôô"}[v]||"") : v;
                c.onclick = () => move(i, d); board.appendChild(c);
            });
            cont.appendChild(board);
        }

        async function move(i, d) {
            if(d.turn !== (myRole==='p1'?'p1':'p2')) return;
            let nb = typeof d.board === 'string' ? d.board.split('') : [...d.board];
            if(d.type === 'ttt') { if(nb[i] !== '') return; nb[i] = myRole === 'p1' ? 'X' : 'O'; }
            else { 
                let sel = localStorage.getItem('cs'); 
                if(!sel) { if(nb[i] !== '.') localStorage.setItem('cs', i); return; }
                nb[i] = nb[sel]; nb[sel] = '.'; localStorage.removeItem('cs');
            }
            update(ref(db, 'games/'+gid), {board: typeof d.board === 'string' ? nb.join('') : nb, turn: d.turn === 'p1' ? 'p2' : 'p1'});
        }

        window.openMod = (id) => document.getElementById(id).style.display = 'block';
        window.closeMod = (id) => document.getElementById(id).style.display = 'none';
        window.logout = () => { localStorage.clear(); location.reload(); };

        init();
    </script>
</body>
</html>





















