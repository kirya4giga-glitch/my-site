<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Super App v8 - Profiles & Ranks</title>
    <script src="https://js-dos.com/v7/build/releases/latest/js-dos.js"></script>
    <style>
        :root { --bg: #0a0a0a; --main: #0F0; --box: rgba(10, 25, 10, 0.7); --txt: #0F0; }
        body.theme-tg { --bg: #17212b; --main: #5288c1; --box: #242f3d; --txt: #fff; }
        body.theme-light { --bg: #f0f2f5; --main: #0088cc; --box: #ffffff; --txt: #000; }
        body.theme-retro { --bg: #1a1200; --main: #ffb000; --box: #2b1d00; --txt: #ffb000; }
        body.theme-cyber { --bg: #0d0015; --main: #ff00ff; --box: #1a0029; --txt: #00ffff; }
        body.theme-snow { --bg: #001529; --main: #ffffff; --box: rgba(255,255,255,0.1); --txt: #ffffff; }
        body { font-family: 'Consolas', monospace; text-align: center; padding: 20px; background-color: var(--bg); color: var(--txt); margin: 0; transition: 0.3s; overflow-x: hidden; }
        .settings-btn { position: fixed; top: 15px; right: 15px; z-index: 100; cursor: pointer; background: var(--box); padding: 8px; border-radius: 10px; border: 1px solid var(--main); }
        .settings-menu, .profile-card { display: none; position: fixed; top: 60px; right: 15px; z-index: 101; background: var(--box); padding: 15px; border-radius: 10px; border: 1px solid var(--main); text-align: left; width: 240px; box-shadow: 0 0 20px #000; }
        .profile-card { top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .game-box { background: var(--box); padding: 20px; border-radius: 15px; display: inline-block; margin-bottom: 30px; width: 95%; max-width: 450px; border: 1px solid var(--main); position: relative; z-index: 5; }
        .button-tea { display: inline-block; padding: 10px 20px; background: rgba(0,0,0,0.3); color: var(--main); border: 1px solid var(--main); border-radius: 8px; margin: 5px 0; cursor: pointer; font-weight: bold; }
        #cList { height: 250px; overflow-y: auto; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px; border: 1px solid var(--main); margin-bottom: 10px; }
        .msg { margin-bottom: 8px; padding: 8px; border-radius: 8px; background: rgba(255,255,255,0.05); text-align: left; }
        .ttt-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; width: 210px; margin: 15px auto; }
        .ttt-cell { width: 65px; height: 65px; border: 1px solid var(--main); background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; }
        #matrixCanvas, #snowCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        .rank { font-size: 10px; padding: 2px 5px; border-radius: 4px; background: var(--main); color: #000; margin-left: 5px; vertical-align: middle; }
    </style>
</head>
<body class="theme-hacker">
    <canvas id="matrixCanvas"></canvas>
    <canvas id="snowCanvas" style="display:none"></canvas>

    <div class="settings-btn" onclick="toggleSettings()">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
    
    <div class="settings-menu" id="sMenu">
        <label>–¢–µ–º–∞:</label>
        <select onchange="changeTheme(this.value)"><option value="hacker">Hacker</option><option value="tg">Telegram</option><option value="light">Light</option><option value="retro">Retro</option><option value="cyber">Cyberpunk</option><option value="snow">–ù–æ–≤—ã–π –ì–æ–¥ ‚ùÑÔ∏è</option></select>
        <hr>
        <div id="my-profile-info" style="font-size:12px"></div>
        <input type="text" id="statusInp" placeholder="–¢–≤–æ–π —Å—Ç–∞—Ç—É—Å..." style="width:90%; background:#000; color:#0F0; border:1px solid #0F0; margin-top:5px">
        <button class="button-tea" onclick="updateStatus()" style="width:100%">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
    </div>

    <div class="profile-card" id="pCard">
        <h2 id="pc-name">–ò–º—è</h2>
        <div id="pc-rank" class="rank">–†–∞–Ω–≥</div>
        <p id="pc-status">"–°—Ç–∞—Ç—É—Å"</p>
        <div style="text-align:left; font-size:14px">
            –ö–ª–∏–∫–Ω—É–ª —Ä–∞–∑: <span id="pc-clicks">0</span><br>
            –ü–æ–±–µ–¥ –≤ X/O: <span id="pc-wins">0</span>
        </div>
        <button class="button-tea" onclick="document.getElementById('pCard').style.display='none'">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <h1 id="h-title">–ú–æ–π –ø–µ—Ä–≤—ã–π —Å–∞–π—Ç</h1>
    <h2 style="font-size:14px; opacity:0.7">–î–µ–ª–∞–ª —Å–∞–º —á–µ—Å—Ç–Ω–æ!</h2>

    <div class="game-box">
        <h3>–ß–∞—Ç</h3>
        <div id="cList"></div>
        <div style="display:flex; gap:5px">
            <input type="text" id="nInp" placeholder="–ò–º—è" style="width:70px; background:#000; color:#0F0; border:1px solid #0F0; padding:5px">
            <input type="text" id="mInp" placeholder="–¢–µ–∫—Å—Ç..." style="flex:1; background:#000; color:#0F0; border:1px solid #0F0; padding:5px">
            <button class="button-tea" style="margin:0" onclick="addC()">></button>
        </div>
    </div>

    <div class="game-box">
        <h3>–ö–ª–∏–∫–µ—Ä</h3>
        <div id="score" style="font-size:40px">0</div>
        <button class="button-tea" onclick="addScore()" style="padding:20px 40px; font-size:20px">–ö–õ–ò–ö–ù–ò!</button>
        <div id="leader-list" style="font-size:12px; text-align:left; margin-top:10px; border-top:1px solid var(--main)"></div>
    </div>

    <div class="game-box">
        <h3>Online –î—É—ç–ª–∏</h3>
        <div id="active-rooms" style="font-size:12px; margin-bottom:10px"></div>
        <div id="mp-status">–í–æ–π–¥–∏—Ç–µ –≤ —á–∞—Ç</div>
        <button class="button-tea" id="find-btn" onclick="findGame()">–ü–û–ò–°–ö –ò–ì–†–´</button>
        <div id="game-area" style="display:none">
            <div id="player-role"></div>
            <div class="ttt-grid" id="ttt-grid"></div>
            <div id="turn-info"></div>
        </div>
    </div>

    <div class="game-box"><h3>DOOM</h3><div id="doom-container" style="height:200px"></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, set, get, update, remove, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const conf = { apiKey: "AIzaSyChSk0gETRBQ391e4BjPqFsKc_dzjBmT58", databaseURL: "https://my-chat-52203-default-rtdb.firebaseio.com", projectId: "my-chat-52203" };
        const app = initializeApp(conf);
        const db = getDatabase(app);
        let pass = "", myName = "", myRole = "", currentGameId = null;

        const getRank = (s) => {
            if(s > 1000) return "–ü—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç üíª";
            if(s > 500) return "–ú–∞—Å—Ç–µ—Ä üèÜ";
            if(s > 100) return "–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π ‚ö°";
            return "–ù–æ–≤–∏—á–æ–∫ üå±";
        };

        window.showProfile = async (name) => {
            const s = await get(ref(db, 'users/'+name));
            if(!s.exists()) return;
            const d = s.val();
            document.getElementById('pc-name').innerText = name;
            document.getElementById('pc-rank').innerText = getRank(d.score || 0);
            document.getElementById('pc-status').innerText = d.status || "–ù–µ—Ç —Å—Ç–∞—Ç—É—Å–∞";
            document.getElementById('pc-clicks').innerText = d.score || 0;
            document.getElementById('pc-wins').innerText = d.wins || 0;
            document.getElementById('pCard').style.display = 'block';
        };

        window.addC = async () => {
            const n = document.getElementById('nInp'), m = document.getElementById('mInp');
            if(!n.value || !m.value) return;
            if(!pass) {
                const s = await get(ref(db, 'users/'+n.value));
                if(s.exists()){
                    let p = prompt("–ü–∞—Ä–æ–ª—å:"); if(p !== s.val().password) return alert("Error!"); pass = p;
                } else {
                    let p = prompt("–ü–∞—Ä–æ–ª—å:"); if(!p) return;
                    await set(ref(db, 'users/'+n.value), {password: p, score: 0, wins: 0, status: "–í—Å–µ–º –ø—Ä–∏–≤–µ—Ç!"}); pass = p;
                }
                n.readOnly = true; myName = n.value;
                document.getElementById('mp-status').innerText = "–ì–æ—Ç–æ–≤ –∫ –±–æ—é";
                document.getElementById('my-profile-info').innerText = `–í—ã: ${myName}`;
            }
            push(ref(db, 'msgs'), {name: myName, text: m.value}); m.value = "";
        };

        window.updateStatus = () => {
            const st = document.getElementById('statusInp').value;
            if(!myName) return alert("–í–æ–π–¥–∏!");
            update(ref(db, 'users/'+myName), {status: st}); alert("–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω!");
        };

        window.addScore = () => {
            if(!pass) return alert("–í–æ–π–¥–∏!");
            let s = document.getElementById('score'), cur = parseInt(s.innerText) + 1;
            s.innerText = cur; update(ref(db, 'users/'+myName), {score: cur});
        };

        // –ú–£–õ–¨–¢–ò–ü–õ–ï–ï–† –° –ü–û–ë–ï–î–ê–ú–ò
        window.findGame = async () => {
            if(!pass) return alert("–í–æ–π–¥–∏!");
            document.getElementById('find-btn').style.display = 'none';
            const queueRef = ref(db, 'queue');
            const snap = await get(queueRef);
            if(snap.exists() && snap.val().name !== myName) {
                const gameId = 'game_' + Date.now();
                myRole = 'O';
                await set(ref(db, 'games/' + gameId), { p1: snap.val().name, p2: myName, board: Array(9).fill(""), turn: 'X' });
                await remove(queueRef); initGame(gameId);
            } else {
                myRole = 'X'; set(queueRef, { name: myName });
                onValue(ref(db, 'games'), (s) => { s.forEach(g => { if(g.val().p1 === myName) initGame(g.key); }); });
            }
        };

        function initGame(gid) {
            currentGameId = gid;
            document.getElementById('game-area').style.display = 'block';
            onValue(ref(db, 'games/' + gid), async (s) => {
                const data = s.val(); if(!data) return;
                const grid = document.getElementById('ttt-grid'); grid.innerHTML = "";
                data.board.forEach((val, i) => {
                    const cell = document.createElement('div'); cell.className = 'ttt-cell';
                    cell.innerText = val; cell.onclick = () => makeMove(i, data); grid.appendChild(cell);
                });
                document.getElementById('turn-info').innerText = (data.turn === myRole) ? "–¢–í–û–ô –•–û–î!" : "–ñ–¥–µ–º –æ–ø–ø–æ–Ω–µ–Ω—Ç–∞...";
                
                const win = checkWin(data.board);
                if(win) {
                    if(data.turn !== myRole) { // –¢–æ—Ç –∫—Ç–æ –ù–ï —Ö–æ–¥–∏—Ç —Å–µ–π—á–∞—Å - –ø–æ–±–µ–¥–∏–ª
                        alert("–¢–´ –ü–û–ë–ï–î–ò–õ!");
                        const userSnap = await get(ref(db, 'users/'+myName));
                        update(ref(db, 'users/'+myName), {wins: (userSnap.val().wins || 0) + 1});
                    } else { alert("–¢–´ –ü–†–û–ò–ì–†–ê–õ!"); }
                    remove(ref(db, 'games/' + gid)); location.reload();
                }
            });
        }

        async function makeMove(i, data) {
            if(data.turn !== myRole || data.board[i] !== "") return;
            data.board[i] = myRole; data.turn = (myRole === 'X') ? 'O' : 'X';
            update(ref(db, 'games/' + currentGameId), data);
        }

        function checkWin(b) {
            const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            return wins.some(w => b[w[0]] && b[w[0]]==b[w[1]] && b[w[0]]==b[w[2]]);
        }

        onValue(ref(db, 'msgs'), (s) => {
            const l = document.getElementById('cList'); l.innerHTML = "";
            s.forEach(m => {
                const d = m.val();
                l.innerHTML += `<div class="msg"><b style="cursor:pointer" onclick="showProfile('${d.name}')">${d.name}</b>: ${d.text}</div>`;
            });
            l.scrollTop = l.scrollHeight;
        });

        onValue(query(ref(db, 'users'), orderByChild('score'), limitToLast(5)), (s) => {
            const l = document.getElementById('leader-list'); l.innerHTML = "<b>–¢–û–ü (–∫–ª–∏–∫–Ω–∏ –Ω–∞ –∏–º—è):</b><br>";
            let a = []; s.forEach(u => a.push({n:u.key, s:u.val().score}));
            a.sort((x,y)=>y.s-x.s).forEach(u => l.innerHTML += `<span style="cursor:pointer" onclick="showProfile('${u.n}')">${u.n}</span>: ${u.s} [${getRank(u.s)}]<br>`);
        });

        onValue(ref(db, 'games'), (s) => {
            const list = document.getElementById('active-rooms'); list.innerHTML = "";
            s.forEach(g => { const d = g.val(); list.innerHTML += `${d.p1} VS ${d.p2} (–ò–¥–µ—Ç –∏–≥—Ä–∞)<br>`; });
        });
    </script>

    <script>
        function changeTheme(v) { document.body.className = 'theme-' + v; document.getElementById('matrixCanvas').style.display = (v==='hacker')?'block':'none'; document.getElementById('snowCanvas').style.display = (v==='snow')?'block':'none'; }
        function toggleSettings() { const s = document.getElementById('sMenu'); s.style.display = s.style.display==='block'?'none':'block'; }
        
        const mC = document.getElementById('matrixCanvas'), mX = mC.getContext('2d');
        mC.width = window.innerWidth; mC.height = window.innerHeight;
        const drops = Array(Math.floor(mC.width/16)).fill(1);
        setInterval(() => { mX.fillStyle = 'rgba(0,0,0,0.05)'; mX.fillRect(0,0,mC.width,mC.height); mX.fillStyle = '#0F0'; mX.font = '16px monospace'; drops.forEach((y, i) => { mX.fillText(Math.random()>0.5?'0':'1', i*16, y*16); if(y*16>mC.height && Math.random()>0.975) drops[i]=0; drops[i]++; }); }, 33);
        
        window.onload = () => { Dos(document.getElementById("doom-container")).run("https://js-dos.com/v7/build/archive/doom.zip"); };
    </script>
</body>
</html>
