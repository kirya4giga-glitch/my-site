<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Super App v15 - Fixed & Final</title>
    <style>
        :root { --bg: #0a0a0a; --main: #0F0; --box: rgba(15, 30, 15, 0.9); --txt: #0F0; }
        body.theme-tg { --bg: #17212b; --main: #5288c1; --box: #242f3d; --txt: #fff; }
        body.theme-snow { --bg: #001c3d; --main: #ffffff; --box: rgba(255,255,255,0.1); --txt: #fff; }
        body { font-family: 'Consolas', monospace; text-align: center; padding: 20px; background: var(--bg); color: var(--txt); margin: 0; transition: 0.3s; }
        
        .game-box { background: var(--box); padding: 15px; border-radius: 15px; display: inline-block; margin-bottom: 20px; width: 95%; max-width: 450px; border: 1px solid var(--main); position: relative; z-index: 5; }
        .button-tea { padding: 8px 12px; background: transparent; color: var(--main); border: 1px solid var(--main); border-radius: 8px; cursor: pointer; font-weight: bold; margin: 5px; font-size: 13px; }
        
        #cList { height: 250px; overflow-y: auto; background: rgba(0,0,0,0.4); border-radius: 10px; padding: 10px; margin-bottom: 10px; text-align: left; border: 1px solid var(--main); }
        .msg { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-bottom: 8px; position: relative; border-left: 3px solid var(--main); cursor: pointer; }
        .del-btn { position: absolute; top: 5px; right: 5px; color: #ff4d4d; font-size: 12px; cursor: pointer; border: 1px solid #ff4d4d; border-radius: 3px; padding: 0 4px; }
        
        .react-bar { margin-top: 5px; font-size: 12px; display: flex; gap: 8px; opacity: 0.8; }
        .react-item { background: rgba(255,255,255,0.1); padding: 2px 5px; border-radius: 5px; }

        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--box); border: 2px solid var(--main); padding: 25px; border-radius: 15px; z-index: 2000; width: 280px; box-shadow: 0 0 50px #000; }
        .rank { font-size: 11px; background: var(--main); color: #000; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        
        #reactPicker { display: none; position: fixed; background: #222; border: 1px solid var(--main); padding: 10px; border-radius: 50px; z-index: 3000; gap: 10px; font-size: 24px; box-shadow: 0 0 20px var(--main); }
        #matrixCanvas, #snowCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        .hidden { display: none; }
    </style>
</head>
<body class="theme-hacker">
    <canvas id="matrixCanvas"></canvas>
    <canvas id="snowCanvas" class="hidden"></canvas>

    <div style="position:fixed; top:15px; right:15px; z-index:1001">
        <button class="button-tea" onclick="openMenu()">‚öôÔ∏è</button>
    </div>

    <h1 id="h-title">–ú–æ–π –ø–µ—Ä–≤—ã–π —Å–∞–π—Ç</h1>
    <h3 id="h-sub">—Å–¥–µ–ª–∞–ª —Å–∞–º —á–µ—Å—Ç–Ω–æ!</h3>

    <div id="pCard" class="modal">
        <h2 id="pc-name">User</h2>
        <div id="pc-rank" class="rank">Rank</div>
        <div id="pc-stats" style="margin: 15px 0; font-size:14px; text-align: left;"></div>
        <button class="button-tea" onclick="resetScore()" style="color:red; border-color:red">–°–±—Ä–æ—Å–∏—Ç—å —Ä–µ–∫–æ—Ä–¥</button><br>
        <button class="button-tea" onclick="closeModal('pCard')">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <div id="sMenu" class="modal">
        <h3 id="h-settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
        –¢–µ–º–∞: <select onchange="changeTheme(this.value)"><option value="hacker">Hacker</option><option value="tg">Telegram</option><option value="snow">Snow</option></select><br><br>
        –Ø–∑—ã–∫: <select onchange="changeLang(this.value)"><option value="ru">RU</option><option value="en">EN</option><option value="ua">UA</option></select>
        <hr>
        <button class="button-tea" onclick="alert('—Å–∫–∏–Ω—É—Ç—å –±—É–¥—É—â–µ–º—É –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç—É –Ω–∞ —á–∞–π: +79216274225 —Å–±–µ—Ä–±–∞–Ω–∫')" id="b-support">–ü–æ–¥–¥–µ—Ä–∂–∏ –º–µ–Ω—è</button>
        <button class="button-tea" onclick="logout()">–í—ã—Ö–æ–¥</button>
        <button class="button-tea" onclick="closeModal('sMenu')">X</button>
    </div>

    <div class="game-box">
        <h3 id="h-chat">–ß–∞—Ç</h3>
        <div id="cList"></div>
        <div style="display:flex; gap:5px">
            <input type="text" id="mInp" placeholder="–¢–µ–∫—Å—Ç..." style="flex:1; background:transparent; border:1px solid var(--main); color:inherit; padding:10px; border-radius:8px">
            <button class="button-tea" onclick="sendMsg()">></button>
        </div>
    </div>

    <div class="game-box">
        <h3 id="h-click">–ö–ª–∏–∫–µ—Ä</h3>
        <div id="score" style="font-size:50px">0</div>
        <button class="button-tea" onclick="doClick()" id="b-click" style="padding:15px 30px">–ö–õ–ò–ö–ù–ò!</button>
        <div id="topList" style="text-align:left; font-size:12px; margin-top:15px; border-top:1px solid var(--main); padding-top:10px"></div>
    </div>

    <div id="reactPicker">
        <span onclick="applyReact('üî•')">üî•</span><span onclick="applyReact('‚ù§Ô∏è')">‚ù§Ô∏è</span>
        <span onclick="applyReact('üëç')">üëç</span><span onclick="applyReact('üòÇ')">üòÇ</span>
        <span onclick="applyReact('üíÄ')">üíÄ</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, update, push, onValue, remove, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const conf = { apiKey: "AIzaSyChSk0gETRBQ391e4BjPqFsKc_dzjBmT58", databaseURL: "https://my-chat-52203-default-rtdb.firebaseio.com", projectId: "my-chat-52203" };
        const db = getDatabase(initializeApp(conf));

        let user = JSON.parse(localStorage.getItem('user_v15'));
        let selMsgId = null;

        const dict = {
            ru: {title:"–ú–æ–π –ø–µ—Ä–≤—ã–π —Å–∞–π—Ç", sub:"—Å–¥–µ–ª–∞–ª —Å–∞–º —á–µ—Å—Ç–Ω–æ!", chat:"–ß–∞—Ç", click:"–ö–ª–∏–∫–µ—Ä", support:"–ü–æ–¥–¥–µ—Ä–∂–∏ –º–µ–Ω—è", bclick: "–ö–õ–ò–ö–ù–ò!", settings: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏"},
            en: {title:"My First App", sub:"honest work!", chat:"Chat", click:"Clicker", support:"Support me", bclick: "CLICK!", settings: "Settings"},
            ua: {title:"–ú—ñ–π –ø–µ—Ä—à–∏–π —Å–∞–π—Ç", sub:"—Ä–æ–±–∏–≤ —Å–∞–º —á–µ—Å–Ω–æ!", chat:"–ß–∞—Ç", click:"–ö–ª—ñ–∫–µ—Ä", support:"–ü—ñ–¥—Ç—Ä–∏–º–∞–π –º–µ–Ω–µ", bclick: "–ö–õ–Ü–ö–ù–ò!", settings: "–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è"}
        };

        window.changeLang = (l) => {
            const t = dict[l];
            document.getElementById('h-title').innerText = t.title;
            document.getElementById('h-sub').innerText = t.sub;
            document.getElementById('h-chat').innerText = t.chat;
            document.getElementById('h-click').innerText = t.click;
            document.getElementById('b-support').innerText = t.support;
            document.getElementById('b-click').innerText = t.bclick;
            document.getElementById('h-settings').innerText = t.settings;
        };

        async function init() {
            if(!user) {
                let n = prompt("–ò–º—è:"); if(!n) return;
                let p = prompt("–ü–∞—Ä–æ–ª—å:");
                const s = await get(ref(db, 'users/'+n));
                if(s.exists()){ if(s.val().password !== p) return location.reload(); user = {name: n, ...s.val()}; }
                else { user = {name: n, password: p, score: 0}; await set(ref(db, 'users/'+n), user); }
                localStorage.setItem('user_v15', JSON.stringify(user));
            }
            document.getElementById('score').innerText = user.score;
            loadChat();
            loadTop();
        }

        window.doClick = () => {
            user.score++;
            document.getElementById('score').innerText = user.score;
            if(user.score === 100) alert("–ò–¥–∏ —Ç—Ä–∞–≤—É –ø–æ—Ç—Ä–æ–≥–∞–π –∑–∞–¥—Ä–æ—Ç üòÇ");
            update(ref(db, 'users/'+user.name), {score: user.score});
            localStorage.setItem('user_v15', JSON.stringify(user));
        };

        window.sendMsg = () => {
            const i = document.getElementById('mInp'); if(!i.value) return;
            push(ref(db, 'msgs'), {n: user.name, t: i.value, r: { 'üî•':0,'‚ù§Ô∏è':0,'üëç':0,'üòÇ':0,'üíÄ':0 }});
            i.value = "";
        };

        function loadChat() {
            onValue(ref(db, 'msgs'), (s) => {
                const l = document.getElementById('cList'); l.innerHTML = "";
                s.forEach(d => {
                    const m = d.val();
                    let rHtml = '<div class="react-bar">';
                    if(m.r) Object.entries(m.r).forEach(([emoji, count]) => {
                        if(count > 0) rHtml += `<span class="react-item">${emoji} ${count}</span>`;
                    });
                    rHtml += '</div>';

                    const div = document.createElement('div');
                    div.className = 'msg';
                    div.innerHTML = `<span class="del-btn" onclick="event.stopPropagation(); deleteMsg('${d.key}')">X</span>
                                     <b onclick="event.stopPropagation(); showP('${m.n}')">${m.n}</b>: ${m.t} ${rHtml}`;
                    div.onclick = (e) => {
                        selMsgId = d.key;
                        const p = document.getElementById('reactPicker');
                        p.style.display = 'flex'; p.style.top = (e.clientY - 40)+'px'; p.style.left = e.clientX+'px';
                    };
                    l.appendChild(div);
                });
                l.scrollTop = l.scrollHeight;
            });
        }

        window.applyReact = (emoji) => {
            const rRef = ref(db, `msgs/${selMsgId}/r/${emoji}`);
            get(rRef).then(s => { update(ref(db, `msgs/${selMsgId}/r`), { [emoji]: (s.val() || 0) + 1 }); });
            document.getElementById('reactPicker').style.display = 'none';
        };

        window.deleteMsg = (id) => { if(prompt("Pass:") === "8070") remove(ref(db, 'msgs/'+id)); };

        window.resetScore = () => {
            if(prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è —Å–±—Ä–æ—Å–∞:") === "8070") {
                user.score = 0;
                update(ref(db, 'users/'+user.name), {score: 0});
                document.getElementById('score').innerText = 0;
                localStorage.setItem('user_v15', JSON.stringify(user));
                alert("–†–µ–∫–æ—Ä–¥ –æ—á–∏—â–µ–Ω!");
                location.reload();
            }
        };

        window.showP = async (n) => {
            const s = await get(ref(db, 'users/'+n)); const d = s.val();
            document.getElementById('pc-name').innerText = n;
            document.getElementById('pc-rank').innerText = d.score > 500 ? "–ú–ê–°–¢–ï–† üî•" : "–ù–û–í–ò–ß–û–ö üå±";
            document.getElementById('pc-stats').innerHTML = `–ö–õ–ò–ö–û–í: <b>${d.score}</b><br>–°–¢–ê–¢–£–°: –ê–∫—Ç–∏–≤–µ–Ω`;
            document.getElementById('pCard').style.display = 'block';
        };

        function loadTop() {
            onValue(query(ref(db, 'users'), orderByChild('score'), limitToLast(10)), (s) => {
                const t = document.getElementById('topList'); t.innerHTML = "<b>–¢–û–ü –õ–ò–î–ï–†–û–í (–ö–õ–ò–ö–ò):</b><br>";
                let a = []; s.forEach(u => a.push({n:u.key, s:u.val().score}));
                a.sort((x,y)=>y.s-x.s).forEach((u,i) => t.innerHTML += `<div onclick="showP('${u.n}')" style="cursor:pointer">${i+1}. ${u.n} ‚Äî <b style="color:#fff">${u.s}</b> –∫–ª–∏–∫–æ–≤</div>`);
            });
        }

        window.openMenu = () => document.getElementById('sMenu').style.display = 'block';
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';
        window.logout = () => { localStorage.clear(); location.reload(); };
        window.changeTheme = (v) => { document.body.className = 'theme-'+v; document.getElementById('matrixCanvas').classList.toggle('hidden', v!=='hacker'); document.getElementById('snowCanvas').classList.toggle('hidden', v!=='snow'); };

        init();
        window.onclick = (e) => { if(!e.target.closest('.msg')) document.getElementById('reactPicker').style.display = 'none'; };
    </script>

    <script>
        const mC = document.getElementById('matrixCanvas'), mX = mC.getContext('2d');
        mC.width = window.innerWidth; mC.height = window.innerHeight;
        const drops = Array(Math.floor(mC.width/16)).fill(1);
        setInterval(() => { mX.fillStyle = 'rgba(0,0,0,0.05)'; mX.fillRect(0,0,mC.width,mC.height); mX.fillStyle = '#0F0'; mX.font = '16px monospace';
            drops.forEach((y, i) => { mX.fillText(Math.random()>0.5?'0':'1', i*16, y*16); if(y*16>mC.height && Math.random()>0.975) drops[i]=0; drops[i]++; });
        }, 33);
    </script>
</body>
</html>







