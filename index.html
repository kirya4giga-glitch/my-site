<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Super App v12 - Absolute Final</title>
    <style>
        :root { --bg: #0a0a0a; --main: #0F0; --box: rgba(10, 25, 10, 0.7); --txt: #0F0; }
        body.theme-tg { --bg: #17212b; --main: #5288c1; --box: #242f3d; --txt: #fff; }
        body.theme-snow { --bg: #001c3d; --main: #ffffff; --box: rgba(255,255,255,0.15); --txt: #fff; }
        body.theme-cyber { --bg: #0d0015; --main: #ff00ff; --box: #1a0029; --txt: #00ffff; }
        
        body { font-family: 'Consolas', monospace; text-align: center; padding: 20px; background: var(--bg); color: var(--txt); margin: 0; transition: 0.3s; overflow-x: hidden; }
        .game-box { background: var(--box); padding: 15px; border-radius: 15px; display: inline-block; margin-bottom: 20px; width: 95%; max-width: 450px; border: 1px solid var(--main); position: relative; z-index: 5; box-shadow: 0 0 15px rgba(0,0,0,0.5); }
        .button-tea { padding: 10px 15px; background: transparent; color: var(--main); border: 1px solid var(--main); border-radius: 8px; cursor: pointer; font-weight: bold; margin: 5px; }
        .button-tea:hover { background: var(--main); color: #000; }
        
        #cList { height: 250px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 10px; padding: 10px; margin-bottom: 10px; text-align: left; border: 1px solid var(--main); }
        .msg { background: rgba(255,255,255,0.05); padding: 8px; border-radius: 8px; margin-bottom: 8px; position: relative; border-left: 3px solid var(--main); }
        .react-btn { cursor: pointer; font-size: 12px; margin-right: 5px; opacity: 0.6; }
        .react-btn:hover { opacity: 1; }

        .chess-board, .ttt-grid { display: grid; margin: 10px auto; border: 2px solid var(--main); background: #000; }
        .chess-board { grid-template-columns: repeat(8, 1fr); width: 280px; height: 280px; }
        .ttt-grid { grid-template-columns: repeat(3, 1fr); width: 210px; height: 210px; }
        .cell { display: flex; align-items: center; justify-content: center; cursor: pointer; border: 0.1px solid rgba(255,255,255,0.1); }
        .cell-w { background: #eee; color: #222; } .cell-b { background: #555; color: #fff; }
        
        .settings-btn { position: fixed; top: 15px; right: 15px; z-index: 1000; cursor: pointer; font-size: 24px; }
        #matrixCanvas, #snowCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        .hidden { display: none; }
    </style>
</head>
<body class="theme-hacker">
    <canvas id="matrixCanvas"></canvas>
    <canvas id="snowCanvas" class="hidden"></canvas>

    <div class="settings-btn" onclick="toggleMenu()">‚öôÔ∏è</div>

    <div id="sMenu" class="game-box hidden" style="position:fixed; top:60px; right:15px; width:220px; z-index:1001">
        <label>–¢–µ–º–∞:</label>
        <select onchange="changeTheme(this.value)"><option value="hacker">Hacker</option><option value="tg">Telegram</option><option value="snow">Snow ‚ùÑÔ∏è</option><option value="cyber">Cyber</option></select>
        <br><label>–Ø–∑—ã–∫:</label>
        <select onchange="changeLang(this.value)"><option value="ru">RU</option><option value="en">EN</option><option value="ua">UA</option></select>
        <hr>
        <button class="button-tea" onclick="alert('–ù–∞ —á–∞–π: +79216274225')">–ù–∞ —á–∞–π ‚òï</button>
        <button class="button-tea" onclick="logout()" style="color:red">–í—ã—Ö–æ–¥</button>
    </div>

    <h1 id="h-title">–ú–æ–π –ø–µ—Ä–≤—ã–π —Å–∞–π—Ç</h1>
    <h3 id="h-sub">v12: Multiplayer + Spectator</h3>

    <div class="game-box">
        <h3 id="h-chat">–ß–∞—Ç</h3>
        <div id="cList"></div>
        <div style="display:flex; gap:5px">
            <input type="text" id="mInp" placeholder="..." style="flex:1; background:transparent; border:1px solid var(--main); color:inherit; padding:5px">
            <button class="button-tea" onclick="sendMsg()">></button>
        </div>
    </div>

    <div class="game-box">
        <h3 id="h-click">–ö–ª–∏–∫–µ—Ä</h3>
        <div id="score" style="font-size:40px">0</div>
        <button class="button-tea" onclick="doClick()" style="padding:15px 30px">–ö–õ–ò–ö–ù–ò!</button>
        <div id="topList" style="text-align:left; font-size:11px; margin-top:10px; border-top: 1px solid var(--main)"></div>
    </div>

    <div class="game-box">
        <h3 id="h-games">–ò–≥—Ä–æ–≤–æ–π –¶–µ–Ω—Ç—Ä</h3>
        <div id="active-games" style="font-size:10px; margin-bottom:10px"></div>
        <div id="g-status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        
        <div id="lobby">
            <button class="button-tea" onclick="startMM('ttt')">–ö—Ä–µ—Å—Ç–∏–∫–∏-–ù–æ–ª–∏–∫–∏</button>
            <button class="button-tea" onclick="startMM('chess')">–®–∞—Ö–º–∞—Ç—ã</button>
        </div>

        <div id="searching-ui" class="hidden">
            <p>–ü–æ–∏—Å–∫ –æ–ø–ø–æ–Ω–µ–Ω—Ç–∞...</p>
            <button class="button-tea" style="color:red; border-color:red" onclick="stopMM()">–û–¢–ú–ï–ù–ò–¢–¨</button>
        </div>

        <div id="game-area" class="hidden">
            <div id="g-info" style="font-weight:bold; margin-bottom:5px"></div>
            <div id="board-container"></div>
            <button class="button-tea" onclick="location.reload()">–í—ã–π—Ç–∏ –∏–∑ –∏–≥—Ä—ã</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, update, push, onValue, remove, query, orderByChild, limitToLast, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const conf = { apiKey: "AIzaSyChSk0gETRBQ391e4BjPqFsKc_dzjBmT58", databaseURL: "https://my-chat-52203-default-rtdb.firebaseio.com", projectId: "my-chat-52203" };
        const db = getDatabase(initializeApp(conf));

        let user = JSON.parse(localStorage.getItem('app_user'));
        let gid = null, myRole = '', gType = '', mmListener = null;

        async function init() {
            if(!user) {
                let n = prompt("–ò–º—è:"); if(!n) return;
                let p = prompt("–ü–∞—Ä–æ–ª—å:");
                const s = await get(ref(db, 'users/'+n));
                if(s.exists()){
                    if(s.val().password !== p) return alert("–ù–µ–≤–µ—Ä–Ω–æ!");
                    user = {name: n, ...s.val()};
                } else {
                    user = {name: n, password: p, score: 0, wins: 0};
                    await set(ref(db, 'users/'+n), user);
                }
                localStorage.setItem('app_user', JSON.stringify(user));
            }
            document.getElementById('score').innerText = user.score;
            document.getElementById('g-status').innerText = "–ü—Ä–∏–≤–µ—Ç, " + user.name;
            loadTop();
            loadActiveGames();
        }

        window.doClick = () => {
            user.score++;
            document.getElementById('score').innerText = user.score;
            if(user.score === 100) alert("–ò–¥–∏ —Ç—Ä–∞–≤—É –ø–æ—Ç—Ä–æ–≥–∞–π –∑–∞–¥—Ä–æ—Ç üòÇ");
            update(ref(db, 'users/'+user.name), {score: user.score});
            localStorage.setItem('app_user', JSON.stringify(user));
        };

        window.sendMsg = () => {
            const i = document.getElementById('mInp');
            if(!i.value) return;
            push(ref(db, 'msgs'), {n: user.name, t: i.value, r: {}});
            i.value = "";
        };

        onValue(ref(db, 'msgs'), (s) => {
            const l = document.getElementById('cList'); l.innerHTML = "";
            s.forEach(d => {
                const m = d.val();
                let rs = "";
                ['üî•','üòÇ','‚ù§Ô∏è','üëç','üí©','üíÄ'].forEach(e => {
                    let c = m.r && m.r[e] ? Object.keys(m.r[e]).length : 0;
                    rs += `<span class="react-btn" onclick="react('${d.key}','${e}')">${e}${c||''}</span>`;
                });
                l.innerHTML += `<div class="msg"><b>${m.n}</b>: ${m.t} <span onclick="delM('${d.key}')" style="float:right;color:red;cursor:pointer">√ó</span><br>${rs}</div>`;
            });
            l.scrollTop = l.scrollHeight;
        });

        window.react = (id, e) => { update(ref(db, `msgs/${id}/r/${e}/${user.name}`), true); };
        window.delM = (id) => { if(prompt("Pass:")==="8070") remove(ref(db, 'msgs/'+id)); };

        function loadTop() {
            onValue(query(ref(db, 'users'), orderByChild('score'), limitToLast(5)), (s) => {
                const t = document.getElementById('topList'); t.innerHTML = "<b>–¢–û–ü –õ–ò–î–ï–†–û–í:</b><br>";
                let a = []; s.forEach(u => a.push({n:u.key, s:u.val().score}));
                a.reverse().forEach(u => t.innerHTML += `${u.n}: ${u.s} –∫–ª–∏–∫–æ–≤<br>`);
            });
        }

        // –ú–£–õ–¨–¢–ò–ü–õ–ï–ï–† + –ù–ê–ë–õ–Æ–î–ê–¢–ï–õ–¨
        function loadActiveGames() {
            onValue(ref(db, 'games'), (s) => {
                const a = document.getElementById('active-games'); a.innerHTML = "";
                s.forEach(g => {
                    const d = g.val();
                    a.innerHTML += `üéÆ ${d.p1} vs ${d.p2} <button class="button-tea" style="padding:2px 5px; font-size:9px" onclick="watch('${g.key}')">–°–ú–û–¢–†–ï–¢–¨</button><br>`;
                });
            });
        }

        window.watch = (id) => { join(id, 'spectator'); };

        window.startMM = async (type) => {
            gType = type;
            document.getElementById('lobby').classList.add('hidden');
            document.getElementById('searching-ui').classList.remove('hidden');
            const qRef = ref(db, 'queue_'+type);
            const snap = await get(qRef);
            if(snap.exists() && snap.val() !== user.name) {
                const id = 'g_'+Date.now();
                await set(ref(db, 'games/'+id), {
                    p1: snap.val(), p2: user.name, type, turn: 'p1',
                    board: type==='ttt' ? Array(9).fill("") : "rnbqkbnrpppppppp................................PPPPPPPPRNBQKBNR"
                });
                await remove(qRef); join(id, 'p2');
            } else {
                await set(qRef, user.name);
                mmListener = onValue(ref(db, 'games'), (s) => {
                    s.forEach(g => { if(g.val().p1 === user.name) join(g.key, 'p1'); });
                });
            }
        };

        window.stopMM = async () => {
            if(mmListener) off(ref(db, 'games'));
            await remove(ref(db, 'queue_'+gType));
            location.reload();
        };

        function join(id, role) {
            if(mmListener) off(ref(db, 'games'));
            gid = id; myRole = role;
            document.getElementById('searching-ui').classList.add('hidden');
            document.getElementById('lobby').classList.add('hidden');
            document.getElementById('game-area').classList.remove('hidden');
            onValue(ref(db, 'games/'+id), (s) => {
                const d = s.val(); if(!d) return;
                draw(d);
                document.getElementById('g-info').innerText = role==='spectator' ? `–ù–∞–±–ª—é–¥–µ–Ω–∏–µ: ${d.p1} vs ${d.p2}` : (d.turn === (role==='p1'?'p1':'p2') ? "–¢–í–û–ô –•–û–î!" : "–ñ–¥–µ–º –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞...");
            });
        }

        function draw(d) {
            const cont = document.getElementById('board-container'); cont.innerHTML = "";
            const board = document.createElement('div');
            board.className = d.type==='ttt'?'ttt-grid':'chess-board';
            const bArr = typeof d.board === 'string' ? d.board.split('') : d.board;
            bArr.forEach((v, i) => {
                const c = document.createElement('div');
                c.className = 'cell ' + ((d.type==='chess' && (Math.floor(i/8)+i%8)%2) ? 'cell-b' : 'cell-w');
                c.innerText = d.type==='chess' ? ({"r":"‚ôú","n":"‚ôû","b":"‚ôù","q":"‚ôõ","k":"‚ôö","p":"‚ôü","R":"‚ôñ","N":"‚ôò","B":"‚ôó","Q":"‚ôï","K":"‚ôî","P":"‚ôô"}[v]||"") : v;
                c.onclick = () => move(i, d);
                board.appendChild(c);
            });
            cont.appendChild(board);
        }

        async function move(i, d) {
            if(myRole === 'spectator' || d.turn !== (myRole==='p1'?'p1':'p2')) return;
            let nb = typeof d.board === 'string' ? d.board.split('') : [...d.board];
            if(d.type==='ttt') { if(nb[i]!=='') return; nb[i]=myRole==='p1'?'X':'O'; }
            else { 
                let sel = parseInt(localStorage.getItem('sel_sq'));
                if(isNaN(sel)) { if(nb[i]!=='.') localStorage.setItem('sel_sq', i); return; }
                nb[i] = nb[sel]; nb[sel] = '.'; localStorage.removeItem('sel_sq');
            }
            update(ref(db, 'games/'+gid), {board: typeof d.board === 'string'?nb.join(''):nb, turn: d.turn==='p1'?'p2':'p1'});
        }

        window.logout = () => { localStorage.clear(); location.reload(); };
        init();
    </script>

    <script>
        function toggleMenu() { document.getElementById('sMenu').classList.toggle('hidden'); }
        function changeTheme(v) { document.body.className = 'theme-'+v; document.getElementById('matrixCanvas').classList.toggle('hidden', v!=='hacker'); document.getElementById('snowCanvas').classList.toggle('hidden', v!=='snow'); }
        
        // –ú–∞—Ç—Ä–∏—Ü–∞
        const mC = document.getElementById('matrixCanvas'), mX = mC.getContext('2d');
        mC.width = window.innerWidth; mC.height = window.innerHeight;
        const drops = Array(Math.floor(mC.width/16)).fill(1);
        setInterval(() => {
            mX.fillStyle = 'rgba(0,0,0,0.05)'; mX.fillRect(0,0,mC.width,mC.height);
            mX.fillStyle = '#0F0'; mX.font = '16px monospace';
            drops.forEach((y, i) => { mX.fillText(Math.random()>0.5?'0':'1', i*16, y*16); if(y*16>mC.height && Math.random()>0.975) drops[i]=0; drops[i]++; });
        }, 33);
    </script>
</body>
</html>



