<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kiru OS v34.1 - GOD EDITION</title>
    <style>
        :root { 
            --bg: #000; --card-bg: rgba(28, 28, 30, 0.85); --txt: #fff; --main: #0A84FF; 
            --red: #FF453A; --green: #30D158; --gold: #FFD60A; --font: -apple-system, sans-serif;
            --shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        /* –¢–ï–ú–´ */
        body.t-light { --bg: #F2F2F7; --card-bg: rgba(255,255,255,0.8); --txt: #000; --main: #007AFF; --shadow: 0 10px 30px rgba(0,0,0,0.1); }
        body.t-hacker { --bg: #000; --card-bg: rgba(0, 20, 0, 0.9); --txt: #00FF41; --main: #008F11; }
        body.t-retro { --bg: #2b213a; --card-bg: rgba(255, 0, 128, 0.15); --txt: #ff0080; --main: #00e5ff; }
        body.t-snow { --bg: #e3f2fd; --card-bg: rgba(255,255,255,0.7); --txt: #01579b; --main: #0288d1; }
        body.t-cyber { --bg: #050510; --card-bg: rgba(20, 10, 40, 0.8); --txt: #00f3ff; --main: #bc13fe; --red: #ff003c; }

        body {
            background: var(--bg); color: var(--txt); font-family: var(--font);
            margin: 0; padding: 15px; overflow-x: hidden; transition: background 0.5s, color 0.5s;
            -webkit-user-select: none; user-select: none;
        }

        /* CANVAS BACK */
        #bg-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }

        /* UI ELEMENTS */
        .card {
            background: var(--card-bg); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border-radius: 24px; padding: 20px; margin-bottom: 20px;
            box-shadow: var(--shadow); border: 1px solid rgba(128,128,128,0.1);
            animation: slideIn 0.4s ease-out;
        }

        .btn {
            background: var(--main); color: #fff; border: none; padding: 14px; 
            border-radius: 16px; font-weight: 600; font-size: 15px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: 0.2s;
            width: 100%; margin-top: 5px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .btn:active { transform: scale(0.96); opacity: 0.8; }
        .btn-red { background: var(--red); }
        .btn-green { background: var(--green); }
        .btn-gold { background: var(--gold); color: #000; box-shadow: 0 0 15px rgba(255, 215, 0, 0.4); }

        input, select {
            width: 100%; padding: 12px; border-radius: 12px; border: 1px solid rgba(128,128,128,0.2);
            background: rgba(128,128,128,0.1); color: var(--txt); margin-bottom: 10px;
            font-size: 16px; outline: none; box-sizing: border-box;
        }

        /* HEADER */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .h-title { font-size: 24px; font-weight: 900; margin: 0; }
        .h-online { font-size: 11px; color: var(--green); font-weight: bold; }
        .icon-bar { display: flex; gap: 8px; }
        .icon-btn { width: 40px; height: 40px; padding: 0; font-size: 20px; margin: 0; }

        /* CLICKER AREA */
        #score-area { text-align: center; position: relative; }
        #balance { font-size: 56px; font-weight: 800; letter-spacing: -2px; line-height: 1; }
        .lvl-cont { background: rgba(128,128,128,0.2); height: 6px; border-radius: 3px; margin: 15px 0; overflow: hidden; }
        .lvl-fill { height: 100%; background: var(--main); width: 0%; transition: 0.3s; }
        .click-fx { position: absolute; font-weight: 900; font-size: 20px; pointer-events: none; animation: floatUp 0.8s forwards; color: var(--txt); }

        /* CHAT & LISTS */
        .scroll-list { height: 250px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; padding-bottom: 10px; }
        .msg { background: rgba(128,128,128,0.1); padding: 10px; border-radius: 14px; font-size: 13px; position: relative; }
        .msg b { cursor: pointer; opacity: 0.9; }
        .msg-time { font-size: 9px; opacity: 0.5; float: right; margin-top: 2px; }
        .del-btn { color: var(--red); font-weight: bold; cursor: pointer; margin-left: 5px; }

        .top-row { display: flex; justify-content: space-between; padding: 10px; background: rgba(128,128,128,0.05); border-radius: 12px; align-items: center; }
        /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π —Ç–æ–ø–∞ */
        .top-left { display: flex; flex-direction: column; }
        .top-sub { font-size: 10px; opacity: 0.6; margin-top: 2px; }
        .top-right { display: flex; align-items: center; gap: 10px; }
        .del-u-btn { color: var(--red); font-weight: bold; cursor: pointer; font-size: 18px; line-height: 1; }

        /* MODALS */
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 400px; max-height: 85vh; background: var(--card-bg); border-radius: 30px; z-index: 1000; padding: 25px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px); box-shadow: 0 50px 100px rgba(0,0,0,0.8); }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 999; backdrop-filter: blur(4px); }
        .close-mod { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; opacity: 0.6; }

        /* GAME BOARDS */
        .board-ttt { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; width: 200px; margin: 0 auto; }
        .cell-ttt { height: 60px; background: rgba(128,128,128,0.1); display: flex; align-items: center; justify-content: center; font-size: 28px; border-radius: 10px; cursor: pointer; }
        .board-chess { display: grid; grid-template-columns: repeat(8, 1fr); gap: 1px; width: 100%; background: #999; border: 2px solid #555; }
        .cell-chess { height: 35px; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; background: #eee; }
        .cell-chess.dark { background: #333; color: #fff; }
        .cell-chess.selected { background: var(--green) !important; }

        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-50px); } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="t-dark">

    <canvas id="bg-canvas"></canvas>
    <div class="overlay" id="overlay"></div>

    <div class="header">
        <div>
            <h1 class="h-title">Kiru OS v34</h1>
            <div id="online-stat" class="h-online">‚óè Online: ...</div>
        </div>
        <div class="icon-bar">
            <button class="btn icon-btn btn-gold" onclick="openM('daily')">üéÅ</button>
            <button class="btn icon-btn" onclick="openM('clans')">üõ°Ô∏è</button>
            <button class="btn icon-btn" onclick="openM('shop')">üõí</button>
            <button class="btn icon-btn" onclick="openM('settings')">‚öôÔ∏è</button>
        </div>
    </div>

    <div class="card" id="score-area">
        <div id="lbl-bal" style="opacity:0.6; text-transform:uppercase; font-size:12px;">–ë–∞–ª–∞–Ω—Å</div>
        <div id="balance">0</div>
        
        <div style="display:flex; justify-content:space-between; font-size:12px; margin-top:10px; font-weight:bold;">
            <span id="lvl-txt">LVL 1</span>
            <span id="exp-txt">0 / 500</span>
        </div>
        <div class="lvl-cont"><div id="lvl-bar" class="lvl-fill"></div></div>

        <button class="btn" id="tap-btn" style="height:80px; font-size:24px; border-radius:24px;" onclick="tap(event)">TAP</button>
    </div>

    <div class="card">
        <h3 id="lbl-top">–¢–æ–ø –ò–≥—Ä–æ–∫–æ–≤</h3>
        <div id="top-list" class="scroll-list" style="height:150px;"></div>
    </div>

    <div class="card">
        <h3 id="lbl-games">–ú–∏–Ω–∏-–∏–≥—Ä—ã</h3>
        <div style="display:flex; gap:10px;">
            <button class="btn" onclick="findGame('ttt')">–ö—Ä–µ—Å—Ç–∏–∫–∏</button>
            <button class="btn" onclick="findGame('chess')">–®–∞—Ö–º–∞—Ç—ã</button>
        </div>
    </div>

    <div class="card">
        <h3 id="lbl-chat">–ß–∞—Ç</h3>
        <div id="chat-list" class="scroll-list"></div>
        <div style="display:flex; gap:8px;">
            <input type="text" id="msg-in" style="margin:0;" placeholder="...">
            <button class="btn" style="width:60px; margin:0;" onclick="sendMsg()">‚û§</button>
        </div>
    </div>

    <div id="shop" class="modal">
        <span class="close-mod" onclick="closeM()">√ó</span>
        <h2 id="lbl-shop">–ú–∞–≥–∞–∑–∏–Ω</h2>
        <div class="top-row"><span>ü§ñ AutoClick (+1/s)</span><button class="btn" style="width:auto" onclick="buy('auto', 5000)">5k</button></div>
        <div class="top-row"><span>‚ö° Multiplier (+2)</span><button class="btn" style="width:auto" onclick="buy('mult', 10000)">10k</button></div>
        <div class="top-row"><span>üëë Prefix [VIP]</span><button class="btn" style="width:auto" onclick="buy('pref', 50000, 'VIP')">50k</button></div>
        <div class="top-row"><span>üé® Nick Color</span><button class="btn" style="width:auto" onclick="buy('col', 25000, 'rainbow')">25k</button></div>
        <hr style="opacity:0.2">
        <h3>Rebirth (–ü–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏–µ)</h3>
        <p style="font-size:12px; opacity:0.7">–°–±—Ä–æ—Å –¥–µ–Ω–µ–≥ –∏ —É–ª—É—á—à–µ–Ω–∏–π —Ä–∞–¥–∏ –≤–µ—á–Ω–æ–≥–æ x2.</p>
        <button class="btn btn-red" onclick="doRebirth()">–°–¥–µ–ª–∞—Ç—å Rebirth (–ù—É–∂–Ω–æ 1M)</button>
    </div>

    <div id="clans" class="modal">
        <span class="close-mod" onclick="closeM()">√ó</span>
        <h2 id="lbl-clan">–ö–ª–∞–Ω—ã</h2>
        
        <div id="clan-create-ui">
            <input id="clan-name-in" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞–Ω–∞">
            <button class="btn" onclick="createClan()">–°–æ–∑–¥–∞—Ç—å (100k)</button>
        </div>

        <div id="clan-my-ui" style="display:none; background:rgba(255,255,255,0.05); padding:15px; border-radius:15px;">
            <h3 id="my-clan-name">Name</h3>
            <p id="my-clan-stats">Bank: 0</p>
            <div id="clan-mems"></div>
            <button class="btn btn-red" onclick="leaveClan()">–ü–æ–∫–∏–Ω—É—Ç—å / –£–¥–∞–ª–∏—Ç—å</button>
        </div>
        
        <h4 style="margin-top:20px;">–°–ø–∏—Å–æ–∫ –∫–ª–∞–Ω–æ–≤:</h4>
        <div id="clan-list" class="scroll-list" style="height:150px;"></div>
    </div>

    <div id="settings" class="modal">
        <span class="close-mod" onclick="closeM()">√ó</span>
        <h2 id="lbl-set">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
        
        <label>Language / –Ø–∑—ã–∫:</label>
        <select id="lang-sel" onchange="changeLang(this.value)">
            <option value="rus">–†—É—Å—Å–∫–∏–π</option>
            <option value="eng">English</option>
            <option value="ukr">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
        </select>

        <label>Theme / –¢–µ–º–∞:</label>
        <select onchange="setTheme(this.value)">
            <option value="dark">Dark iOS</option>
            <option value="light">Light iOS</option>
            <option value="hacker">Hacker (Matrix)</option>
            <option value="snow">Snow (–ó–∏–º–∞)</option>
            <option value="retro">Retro</option>
            <option value="cyber">Cyberpunk</option>
        </select>

        <button class="btn btn-gold" onclick="openM('support')">‚òï –ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å –º–µ–Ω—è</button>
        <button class="btn btn-green" onclick="openM('credits')">üåü –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏</button>
        <button class="btn btn-red" onclick="resetUpgrades()">‚ö† –°–±—Ä–æ—Å —É–ª—É—á—à–µ–Ω–∏–π</button>
        <button class="btn btn-red" onclick="logout()">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
    </div>

    <div id="support" class="modal">
        <span class="close-mod" onclick="closeM()">√ó</span>
        <h3>–ù–∞ —á–∞–π –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç—É ‚òï</h3>
        <p>–ù–æ–º–µ—Ä –¥–ª—è –¥–æ–Ω–∞—Ç–∞ (–°–±–µ—Ä/–°–ë–ü):</p>
        <h2 style="color:var(--main); user-select:text;">+79216274225</h2>
        <p>–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏!</p>
    </div>

    <div id="credits" class="modal">
        <span class="close-mod" onclick="closeM()">√ó</span>
        <h3>–û—Å–æ–±–∞—è –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å</h3>
        <ul style="line-height:2; list-style:none; padding:0;">
            <li>üëë <b>–í–∞–¥–µ–∫</b> (Founder)</li>
            <li>üòé <b>–°–∞—à–∞</b></li>
            <li>üêπ <b>–ê–Ω–∞—Å—Ç–∞—Å–∏—è –ó–µ–º–ª–µ—Ä–æ–π–∫–∞</b></li>
            <li>üëæ <b>–¢–µ–ø–µ</b></li>
            <li>üî• <b>–ê–Ω–¥—Ä–µ–π</b>üòé</li>
            <li>ü§ñ <b>Gemini AI</b></li>
            <li id="musya-egg" style="color:var(--red); font-weight:bold; cursor:pointer">‚ù§Ô∏è –ú—É—Å—è</li>
        </ul>
    </div>

    <div id="daily" class="modal" style="text-align:center;">
        <span class="close-mod" onclick="closeM()">√ó</span>
        <h2>–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞</h2>
        <div id="daily-status" style="margin:20px; font-size:18px;">...</div>
        <button class="btn btn-gold" id="daily-btn" onclick="claimDaily()">–ó–∞–±—Ä–∞—Ç—å 10,000 üí∞</button>
    </div>

    <div id="game-win" class="modal" style="text-align:center;">
        <h3 id="g-title">Game</h3>
        <div id="g-status">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
        <div id="g-board" style="margin:20px auto;"></div>
        <button class="btn btn-red" onclick="quitGame()">–°–¥–∞—Ç—å—Å—è / –í—ã–π—Ç–∏</button>
    </div>

    <div id="profile" class="modal">
        <span class="close-mod" onclick="closeM()">√ó</span>
        <h2 id="p-name">User</h2>
        <div id="p-stats" style="line-height:1.8; opacity:0.8;"></div>
        <hr>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <button class="btn" onclick="sendMoneyUi()">üí∏ Send $</button>
            <button class="btn btn-red" onclick="adminAct('mute')">Mute (Adm)</button>
            <button class="btn btn-red" onclick="adminAct('unmute')">Unmute (Adm)</button>
            <button class="btn btn-red" onclick="adminAct('reset')">Wipe $ (Adm)</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, update, push, onValue, remove, serverTimestamp, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const db = getDatabase(initializeApp({ apiKey: "AIzaSyChSk0gETRBQ391e4BjPqFsKc_dzjBmT58", databaseURL: "https://my-chat-52203-default-rtdb.firebaseio.com", projectId: "my-chat-52203" }));

        // GLOBAL VARS
        let user = JSON.parse(localStorage.getItem('kiru_god_v34'));
        let loopId = null, canvasId = null;
        let curGameId = null, myRole = null;
        let selectedCell = null; // Chess

        // LANGUAGE DATA
        const txt = {
            rus: { bal:"–ë–∞–ª–∞–Ω—Å", top:"–¢–æ–ø –ò–≥—Ä–æ–∫–æ–≤", chat:"–ß–∞—Ç", games:"–ú–∏–Ω–∏-–∏–≥—Ä—ã", shop:"–ú–∞–≥–∞–∑–∏–Ω", set:"–ù–∞—Å—Ç—Ä–æ–π–∫–∏", clan:"–ö–ª–∞–Ω—ã" },
            eng: { bal:"Balance", top:"Leaderboard", chat:"Chat", games:"Mini-Games", shop:"Shop", set:"Settings", clan:"Clans" },
            ukr: { bal:"–ë–∞–ª–∞–Ω—Å", top:"–¢–æ–ø –ì—Ä–∞–≤—Ü—ñ–≤", chat:"–ß–∞—Ç", games:"–ú—ñ–Ω—ñ-—ñ–≥—Ä–∏", shop:"–ú–∞–≥–∞–∑–∏–Ω", set:"–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è", clan:"–ö–ª–∞–Ω–∏" }
        };

        // === INITIALIZATION ===
        async function init() {
            if(!user) {
                let n = prompt("–ù–∏–∫ / Nickname:");
                let p = prompt("–ü–∞—Ä–æ–ª—å / Password:");
                if(!n || !p) return location.reload();
                
                const snap = await get(ref(db, 'users/'+n));
                if(snap.exists()) {
                    if(snap.val().pass !== p) { alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!"); return location.reload(); }
                    user = {name:n, ...snap.val()};
                } else {
                    user = {name:n, pass:p, score:0, clicks:0, lvl:1, exp:0, mult:1, auto:0, skin:'def', wins:0, clan:'', role:'user', musya:false, reb:0};
                    await set(ref(db, 'users/'+n), user);
                }
                saveUser();
            }
            
            // Listeners
            onValue(ref(db, 'users/'+user.name), s => { 
                if(s.exists()) { user = {name:user.name, ...s.val()}; updateUI(); } 
            });
            
            // Online
            const conRef = ref(db, 'status/'+user.name);
            set(conRef, true); onDisconnect(conRef).remove();
            onValue(ref(db, 'status'), s => document.getElementById('online-stat').innerText = `‚óè Online: ${s.size||0}`);

            // Lists
            loadChat(); loadTop(); loadClans();
            
            // Autoclicker
            if(loopId) clearInterval(loopId);
            loopId = setInterval(() => {
                if(user.auto > 0) addScore(user.auto, false);
                checkDaily();
            }, 1000);

            // Defaults
            changeLang('rus');
            setTheme('dark');
        }

        // === CORE GAMEPLAY ===
        function addScore(amt, isClick) {
            let val = Math.floor(amt);
            let nx = (user.exp||0) + (isClick?1:0);
            let nl = user.lvl || 1;
            if(nx >= nl*500) { nx=0; nl++; } // Level Up
            
            update(ref(db, 'users/'+user.name), {
                score: (user.score||0) + val,
                clicks: (user.clicks||0) + (isClick?1:0),
                exp: nx, lvl: nl
            });

            // Clan Tax 5%
            if(user.clan && isClick) {
                get(ref(db, 'clans/'+user.clan)).then(s => {
                    if(s.exists()) update(ref(db, 'clans/'+user.clan), {bank: (s.val().bank||0) + (val*0.05)});
                });
            }
        }

        window.tap = (e) => {
            let pwr = (user.mult||1) * (user.reb ? user.reb*2 : 1);
            addScore(pwr, true);
            
            // Visual +1
            let el = document.createElement('div');
            el.className = 'click-fx';
            el.innerText = '+' + pwr;
            el.style.left = e.clientX + 'px';
            el.style.top = e.clientY + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 700);
        };

        window.doRebirth = async () => {
            if(user.score < 1000000) return alert("–ù—É–∂–µ–Ω 1,000,000!");
            if(confirm("–°–±—Ä–æ—Å–∏—Ç—å –í–°–Å —Ä–∞–¥–∏ x2 –Ω–∞–≤—Å–µ–≥–¥–∞?")) {
                await update(ref(db, 'users/'+user.name), {
                    score: 0, mult: 1, auto: 0, lvl: 1, exp: 0,
                    reb: (user.reb||0) + 1
                });
                alert("–ü–ï–†–ï–†–û–ñ–î–ï–ù–ò–ï –£–°–ü–ï–®–ù–û!");
            }
        };

        function updateUI() {
            document.getElementById('balance').innerText = Math.floor(user.score).toLocaleString();
            document.getElementById('lvl-txt').innerText = "LVL " + (user.lvl||1);
            let max = (user.lvl||1)*500;
            document.getElementById('exp-txt').innerText = `${Math.floor(user.exp||0)} / ${max}`;
            document.getElementById('lvl-bar').style.width = ((user.exp||0)/max*100) + "%";
            saveUser();
        }

        // === CLANS ===
        window.createClan = async () => {
            let n = document.getElementById('clan-name-in').value.trim();
            if(!n || user.score < 100000) return alert("–ù—É–∂–Ω–æ 100–∫ –∏ –∏–º—è!");
            await set(ref(db, 'clans/'+n), {owner:user.name, bank:0, mems:[user.name]});
            await update(ref(db, 'users/'+user.name), {score: user.score-100000, clan:n});
        };

        window.joinClan = async (n) => {
            if(user.clan) return alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–π–¥–∏ –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ!");
            let s = await get(ref(db, 'clans/'+n));
            let m = s.val().mems || [];
            m.push(user.name);
            await update(ref(db, 'clans/'+n), {mems:m});
            await update(ref(db, 'users/'+user.name), {clan:n});
        };

        window.leaveClan = async () => {
            if(!user.clan) return;
            let c = user.clan;
            let s = await get(ref(db, 'clans/'+c));
            if(s.val().owner === user.name) {
                if(confirm("–£–¥–∞–ª–∏—Ç—å –∫–ª–∞–Ω?")) {
                    await remove(ref(db, 'clans/'+c));
                    s.val().mems.forEach(u => update(ref(db, 'users/'+u), {clan:null}));
                }
            } else {
                let m = s.val().mems.filter(x => x !== user.name);
                await update(ref(db, 'clans/'+c), {mems:m});
                await update(ref(db, 'users/'+user.name), {clan:null});
            }
        };

        window.kick = async (who) => {
            let c = user.clan;
            let s = await get(ref(db, 'clans/'+c));
            let m = s.val().mems.filter(x => x !== who);
            await update(ref(db, 'clans/'+c), {mems:m});
            await update(ref(db, 'users/'+who), {clan:null});
        };

        function loadClans() {
            // My Clan UI
            if(user.clan) {
                document.getElementById('clan-create-ui').style.display='none';
                document.getElementById('clan-my-ui').style.display='block';
                get(ref(db, 'clans/'+user.clan)).then(s => {
                    if(!s.exists()) return update(ref(db, 'users/'+user.name), {clan:null});
                    let d = s.val();
                    document.getElementById('my-clan-name').innerText = user.clan;
                    document.getElementById('my-clan-stats').innerText = `Bank: ${Math.floor(d.bank)}`;
                    let html = '';
                    d.mems.forEach(m => {
                        let k = (d.owner === user.name && m !== user.name) ? `<b style="color:red;cursor:pointer" onclick="kick('${m}')">[kick]</b>` : '';
                        html += `<div>${m} ${k}</div>`;
                    });
                    document.getElementById('clan-mems').innerHTML = html;
                });
            } else {
                document.getElementById('clan-create-ui').style.display='block';
                document.getElementById('clan-my-ui').style.display='none';
            }
            // List
            onValue(ref(db, 'clans'), s => {
                let h = '';
                s.forEach(c => {
                    h += `<div class="top-row"><span>${c.key} (${c.val().mems.length})</span><button class="btn" style="width:auto;padding:5px" onclick="joinClan('${c.key}')">+</button></div>`;
                });
                document.getElementById('clan-list').innerHTML = h;
            });
        }

        // === CHAT & ADMIN ===
        window.sendMsg = async () => {
            let t = document.getElementById('msg-in').value;
            if(!t.trim()) return;
            if((user.muteUntil||0) > Date.now()) return alert("–í—ã –≤ –º—É—Ç–µ!");
            await push(ref(db, 'msgs'), {n:user.name, t:t, tm:serverTimestamp(), pref:user.pref||'', col:user.col||''});
            document.getElementById('msg-in').value = '';
        };

        function loadChat() {
            onValue(ref(db, 'msgs'), s => {
                let div = document.getElementById('chat-list'); div.innerHTML = '';
                s.forEach(ss => {
                    let m = ss.val();
                    let dt = m.tm ? new Date(m.tm).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '';
                    let del = '';
                    div.innerHTML += `<div class="msg"><span style="color:${m.col||'var(--main)'}">[${m.pref||'USER'}]</span> <b onclick="showProf('${m.n}')">${m.n}</b>: ${m.t} <span class="msg-time">${dt}</span> <span class="del-btn" onclick="delMsg('${ss.key}')">√ó</span></div>`;
                });
                div.scrollTop = div.scrollHeight;
            });
        }

        window.delMsg = (k) => {
            if(prompt("Admin Code:") === "8070") remove(ref(db, 'msgs/'+k));
        };

        window.adminAct = (act) => {
            let p = prompt("Admin Code:");
            if(p !== "8070") return alert("Wrong code");
            let t = document.getElementById('p-name').innerText;
            if(act === 'mute') update(ref(db, 'users/'+t), {muteUntil: Date.now()+3600000});
            if(act === 'unmute') update(ref(db, 'users/'+t), {muteUntil: 0});
            if(act === 'reset') update(ref(db, 'users/'+t), {score: 0});
        };

        // === GAMES ===
        window.findGame = async (type) => {
            let q = ref(db, 'queue/'+type);
            let s = await get(q);
            if(s.exists() && s.val() !== user.name) {
                let opp = s.val(); await remove(q);
                let gid = 'g_' + Date.now();
                await set(ref(db, 'games/'+gid), {p1:opp, p2:user.name, type:type, turn:opp, board: (type==='ttt'?Array(9).fill(''):initChess())});
                startGame(gid, type, user.name);
            } else {
                await set(q, user.name);
                openM('game-win'); document.getElementById('g-status').innerText = "–ü–æ–∏—Å–∫...";
                onValue(ref(db, 'games'), snap => {
                    snap.forEach(g => { if(g.val().p1 === user.name || g.val().p2 === user.name) startGame(g.key, g.val().type, user.name); });
                });
            }
        };

        function startGame(gid, type, me) {
            curGameId = gid;
            openM('game-win');
            onValue(ref(db, 'games/'+gid), s => {
                if(!s.exists()) { closeM(); return alert("–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞"); }
                let d = s.val();
                let myTurn = (d.turn === me);
                document.getElementById('g-status').innerText = myTurn ? "–í–ê–® –•–û–î!" : "–•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...";
                document.getElementById('g-title').innerText = type.toUpperCase() + ` vs ${me===d.p1?d.p2:d.p1}`;
                renderBoard(d, type, me);
            });
        }

        function renderBoard(d, type, me) {
            let b = document.getElementById('g-board'); b.innerHTML = '';
            if(type === 'ttt') {
                b.className = 'board-ttt';
                d.board.forEach((c, i) => {
                    let cell = document.createElement('div'); cell.className = 'cell-ttt'; cell.innerText = c;
                    cell.onclick = () => { if(d.turn===me && c==='') {
                        let nb = [...d.board]; nb[i] = (me===d.p1?'X':'O');
                        update(ref(db, 'games/'+curGameId), {board:nb, turn:(me===d.p1?d.p2:d.p1)});
                        checkWinTTT(nb, d.p1, d.p2);
                    }};
                    b.appendChild(cell);
                });
            } else {
                // CHESS (Simplified Sandbox)
                b.className = 'board-chess';
                d.board.forEach((p, i) => {
                    let cell = document.createElement('div');
                    cell.className = 'cell-chess ' + ((Math.floor(i/8)+i%8)%2===0?'':'dark');
                    if(i === selectedCell) cell.classList.add('selected');
                    cell.innerText = p;
                    cell.onclick = () => {
                        if(d.turn !== me) return;
                        if(selectedCell === null) { selectedCell = i; renderBoard(d, type, me); }
                        else {
                            let nb = [...d.board]; nb[i] = nb[selectedCell]; nb[selectedCell] = '';
                            update(ref(db, 'games/'+curGameId), {board:nb, turn:(me===d.p1?d.p2:d.p1)});
                            selectedCell = null;
                        }
                    };
                    b.appendChild(cell);
                });
            }
        }

        function checkWinTTT(b, p1, p2) {
            const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            wins.forEach(w => {
                if(b[w[0]] && b[w[0]]===b[w[1]] && b[w[0]]===b[w[2]]) {
                    let winner = b[w[0]]==='X'?p1:p2;
                    alert("Winner: "+winner);
                    update(ref(db, 'users/'+winner), {wins:(user.wins||0)+1, score:user.score+5000});
                    remove(ref(db, 'games/'+curGameId));
                }
            });
        }

        function initChess() {
            const r = ['‚ôú','‚ôû','‚ôù','‚ôõ','‚ôö','‚ôù','‚ôû','‚ôú'];
            const p = Array(8).fill('‚ôü');
            const e = Array(32).fill('');
            const P = Array(8).fill('‚ôô');
            const R = ['‚ôñ','‚ôò','‚ôó','‚ôï','‚ôî','‚ôó','‚ôò','‚ôñ'];
            return [...r, ...p, ...e, ...P, ...R];
        }

        window.quitGame = () => { if(curGameId) remove(ref(db, 'games/'+curGameId)); closeM(); };

        // === MISC ===
        window.buy = async (t, cost, val) => {
            if(user.score < cost) return alert("–ú–∞–ª–æ –¥–µ–Ω–µ–≥!");
            let up = {score: user.score - cost};
            if(t==='auto') up.auto = (user.auto||0) + 1;
            if(t==='mult') up.mult = (user.mult||1) + 2;
            if(t==='pref') up.pref = val;
            if(t==='col') up.col = val;
            await update(ref(db, 'users/'+user.name), up);
            alert("–ö—É–ø–ª–µ–Ω–æ!");
        };

        window.claimDaily = async () => {
            let now = Date.now();
            if(now - (user.lastDaily||0) < 86400000) return;
            await update(ref(db, 'users/'+user.name), {score:user.score+10000, lastDaily:now});
            checkDaily();
        };

        function checkDaily() {
            let diff = (user.lastDaily||0) + 86400000 - Date.now();
            let b = document.getElementById('daily-btn');
            if(diff <= 0) { b.disabled=false; document.getElementById('daily-status').innerText = "–ù–∞–≥—Ä–∞–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞!"; }
            else { b.disabled=true; document.getElementById('daily-status').innerText = `–ñ–¥–∏: ${Math.floor(diff/3600000)}—á ${Math.floor((diff%3600000)/60000)}–º`; }
        }

        window.changeLang = (l) => {
            let t = txt[l];
            document.getElementById('lbl-bal').innerText = t.bal;
            document.getElementById('lbl-top').innerText = t.top;
            document.getElementById('lbl-chat').innerText = t.chat;
            document.getElementById('lbl-games').innerText = t.games;
            document.getElementById('lbl-shop').innerText = t.shop;
            document.getElementById('lbl-set').innerText = t.set;
            document.getElementById('lbl-clan').innerText = t.clan;
        };

        window.setTheme = (t) => {
            document.body.className = 't-'+t;
            let c = document.getElementById('bg-canvas');
            let ctx = c.getContext('2d');
            if(canvasId) clearInterval(canvasId);
            ctx.clearRect(0,0,c.width,c.height);
            c.width = window.innerWidth; c.height = window.innerHeight;

            if(t === 'hacker') {
                let drops = Array(Math.floor(c.width/20)).fill(1);
                canvasId = setInterval(() => {
                    ctx.fillStyle = 'rgba(0,0,0,0.1)'; ctx.fillRect(0,0,c.width,c.height);
                    ctx.fillStyle = '#0F0';
                    drops.forEach((y,i) => {
                        ctx.fillText(String.fromCharCode(0x30A0+Math.random()*96), i*20, y*20);
                        if(y*20 > c.height && Math.random()>0.975) drops[i]=0;
                        drops[i]++;
                    });
                }, 50);
            }
            if(t === 'snow') {
                let flakes = Array(50).fill(0).map(()=>({x:Math.random()*c.width, y:Math.random()*c.height, r:Math.random()*3+1}));
                canvasId = setInterval(() => {
                    ctx.clearRect(0,0,c.width,c.height); ctx.fillStyle='white';
                    flakes.forEach(f => {
                        ctx.beginPath(); ctx.arc(f.x, f.y, f.r, 0, Math.PI*2); ctx.fill();
                        f.y+=1; if(f.y>c.height) f.y=0;
                    });
                }, 30);
            }
        };

        // Musya & Helpers
        document.getElementById('musya-egg').onclick = () => {
            if(user.musya) return alert("–ú—É—Å—è —É–∂–µ –¥–∞–ª–∞ –±–æ–Ω—É—Å!");
            update(ref(db, 'users/'+user.name), {score: user.score+10000, musya:true});
            alert("–ú—É—Å—è: –ú—É—Ä! –î–µ—Ä–∂–∏ 10,000!");
        };

        window.showProf = async (n) => {
            let s = await get(ref(db, 'users/'+n));
            let d = s.val();
            document.getElementById('p-name').innerText = n;
            document.getElementById('p-stats').innerHTML = `
                üí∞: ${d.score}<br>üèÜ Wins: ${d.wins||0}<br>üñ±Ô∏è Clicks: ${d.clicks||0}<br>üõ°Ô∏è Clan: ${d.clan||'-'}
            `;
            openM('profile');
        };

        window.sendMoneyUi = async () => {
            let to = document.getElementById('p-name').innerText;
            let amt = parseInt(prompt("–°—É–º–º–∞:"));
            if(!amt || amt < 0 || amt > user.score) return alert("–û—à–∏–±–∫–∞");
            let s = await get(ref(db, 'users/'+to));
            if(s.exists()) {
                await update(ref(db, 'users/'+user.name), {score:user.score-amt});
                await update(ref(db, 'users/'+to), {score:s.val().score+amt});
                alert("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!");
            }
        };

        function loadTop() {
            onValue(ref(db, 'users'), s => {
                let list = document.getElementById('top-list'); list.innerHTML='';
                let arr = [];
                s.forEach(x => arr.push({n:x.key, ...x.val()}));
                arr.sort((a,b) => b.score - a.score).slice(0,10).forEach((u,i) => {
                    list.innerHTML += `
                    <div class="top-row">
                        <div class="top-left">
                            <span>#${i+1} ${u.n} [${u.lvl||1}]</span>
                            <span class="top-sub">üñ±Ô∏è ${u.clicks||0}</span>
                        </div>
                        <div class="top-right">
                            <b>${Math.floor(u.score)}</b>
                            <span class="del-u-btn" onclick="delUser('${u.n}')">√ó</span>
                        </div>
                    </div>`;
                });
            });
        }

        window.delUser = async (n) => {
            if(prompt("–ü–∞—Ä–æ–ª—å –ê–¥–º–∏–Ω–∞ (—É–¥–∞–ª–∏—Ç—å " + n + "):") === "8070") {
                if(confirm("–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å –∏–≥—Ä–æ–∫–∞ " + n + " –Ω–∞–≤—Å–µ–≥–¥–∞?")) {
                    await remove(ref(db, 'users/'+n));
                    alert("–ò–≥—Ä–æ–∫ " + n + " —É–¥–∞–ª–µ–Ω!");
                }
            } else {
                alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!");
            }
        };

        window.resetUpgrades = () => { if(confirm("–°–±—Ä–æ—Å–∏—Ç—å?")) update(ref(db, 'users/'+user.name), {mult:1, auto:0}); };
        window.saveUser = () => localStorage.setItem('kiru_god_v34', JSON.stringify(user));
        window.logout = () => { localStorage.clear(); location.reload(); };
        window.openM = (id) => { document.getElementById(id).style.display='block'; document.getElementById('overlay').style.display='block'; };
        window.closeM = () => { document.querySelectorAll('.modal').forEach(x=>x.style.display='none'); document.getElementById('overlay').style.display='none'; };

        init();
    </script>
</body>
</html>



























